name: ai_cicd_bouquet

on:
  push:
    branches: [ main ]
    paths:
      - '**.py'
      - '.github/workflows/ai_cicd_bouquet.yml'
  workflow_dispatch: {}

concurrency:
  group: ai-modules-bouquet-${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

env:
  TARGET_DIR: /home/ec2-user/fastapi

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4

      # [디버깅 단계 추가: 키가 제대로 들어왔는지 확인]
      - name: Check Secret Format (Debug)
        run: |
          echo "=== DEBUG START ==="
          echo "1. Key Length check:"
          echo "${{ secrets.EC2_SSH_KEY }}" | wc -c
          echo "2. Line Count check (Must be > 1):"
          echo "${{ secrets.EC2_SSH_KEY }}" | wc -l
          echo "3. First Line check (Must be BEGIN RSA...):"
          echo "${{ secrets.EC2_SSH_KEY }}" | head -n 1
          echo "=== DEBUG END ==="

      - name: Preflight – check required secrets
        run: |
          [ -n "${{ secrets.EC2_HOST }}" ] && \
          [ -n "${{ secrets.EC2_USER }}" ] && \
          [ -n "${{ secrets.EC2_SSH_KEY }}" ] || { 
            echo "Missing one of: EC2_HOST / EC2_USER / EC2_SSH_KEY"; 
            exit 1; 
          }

      - name: Upload ai_modules → EC2
        uses: appleboy/scp-action@v0.1.4
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          source: "./*"
          target: "${{ env.TARGET_DIR }}/"
          overwrite: true
          rm: false
          timeout: "120s"

          use_insecure_cipher: true
          exclude: |
            **/.git/**
            **/.DS_Store
            **/__pycache__/**
            **/.venv/**
            **/venv/**
            **/node_modules/**

      - name: Install deps & restart FastAPI service
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USER }}
          key: ${{ secrets.EC2_SSH_KEY }}
          use_insecure_cipher: true
          script: |
            cd /home/ec2-user/fastapi
            
            echo "OPENROUTER_API_KEY=${{ secrets.OPENROUTER_API_KEY }}" > .env

            if [ ! -d "venv" ]; then
              python3 -m venv venv
            fi

            source venv/bin/activate
            
            # 필요한 패키지 설치
            pip install -r requirements.txt || echo "No requirements.txt found, skipping"
            pip install python-dotenv fastapi uvicorn requests

            deactivate

            sudo systemctl daemon-reload
            sudo systemctl restart fastapi.service